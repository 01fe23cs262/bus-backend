<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    var mymap = L.map('mapid').setView([12.9716, 77.5946], 13);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(mymap);

    var busMarker = null;
    var currentLatLng = null;
    var nextLatLng = null;
    var stepCount = 0;
    var animationInterval = null;

    function getBusLocation() {
        fetch('/get_locations')
            .then(response => response.json())
            .then(data => {
                if (data['bus-01']) {
                    const busLocationData = data['bus-01'];
                    const newLatLng = new L.LatLng(busLocationData.lat, busLocationData.lon);
                    
                    if (busMarker) {
                        // Start animation if the location has changed
                        if (!currentLatLng || !currentLatLng.equals(newLatLng)) {
                            currentLatLng = busMarker.getLatLng();
                            nextLatLng = newLatLng;
                            stepCount = 0;
                            // Clear any existing animation interval
                            if (animationInterval) clearInterval(animationInterval);
                            startAnimation();
                        }
                    } else {
                        // First time, just place the marker
                        busMarker = L.marker(newLatLng).addTo(mymap)
                            .bindPopup(busLocationData.busName + " is here!")
                            .openPopup();
                        mymap.setView(newLatLng, mymap.getZoom());
                        currentLatLng = newLatLng;
                    }
                }
            })
            .catch(error => console.error('Error fetching location:', error));
    }

    function startAnimation() {
        const totalSteps = 100; // Number of small steps to animate
        const animationDuration = 5000; // 5 seconds (5000ms)
        const stepTime = animationDuration / totalSteps;

        animationInterval = setInterval(() => {
            if (stepCount >= totalSteps || !currentLatLng || !nextLatLng) {
                clearInterval(animationInterval);
                return;
            }

            const latDiff = nextLatLng.lat - currentLatLng.lat;
            const lngDiff = nextLatLng.lng - currentLatLng.lng;
            const newLat = currentLatLng.lat + (latDiff * (stepCount / totalSteps));
            const newLng = currentLatLng.lng + (lngDiff * (stepCount / totalSteps));

            busMarker.setLatLng(new L.LatLng(newLat, newLng));
            stepCount++;
        }, stepTime);
    }

    // Check for new bus location every 5 seconds
    setInterval(getBusLocation, 5000);

    // Code for the "Find My Bus" button
    document.getElementById('find-bus-btn').addEventListener('click', function() {
        fetch('/get_locations')
            .then(response => response.json())
            .then(data => {
                if (data['bus-01']) {
                    var busLocation = [data['bus-01'].lat, data['bus-01'].lon];
                    mymap.setView(busLocation, 15);
                } else {
                    alert("Bus not found. Make sure the simulator is running!");
                }
            })
            .catch(error => console.error('Error finding bus:', error));
    });
</script>
