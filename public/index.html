<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"></script>
<script>
    var mymap = L.map('mapid').setView([12.9716, 77.5946], 13);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(mymap);

    var busMarker = null;
    var currentLatLng = null;
    var nextLatLng = null;
    var animationStartTime = null;

    function getBusLocation() {
        fetch('/get_locations')
            .then(response => response.json())
            .then(data => {
                if (data['bus-01']) {
                    const busLocationData = data['bus-01'];
                    const newLatLng = new L.LatLng(busLocationData.lat, busLocationData.lon);

                    if (busMarker) {
                        // If the location has changed, start a new smooth animation
                        if (!currentLatLng || !currentLatLng.equals(newLatLng)) {
                            currentLatLng = busMarker.getLatLng();
                            nextLatLng = newLatLng;
                            animationStartTime = performance.now(); // Start the timer
                            requestAnimationFrame(animateBus); // Start the animation loop
                        }
                    } else {
                        // First time, just place the marker
                        busMarker = L.marker(newLatLng).addTo(mymap)
                            .bindPopup(busLocationData.busName + " is here!")
                            .openPopup();
                        mymap.setView(newLatLng, mymap.getZoom());
                        currentLatLng = newLatLng;
                    }
                }
            })
            .catch(error => console.error('Error fetching location:', error));
    }

    function animateBus(timestamp) {
        if (!animationStartTime) animationStartTime = timestamp;

        const elapsedTime = timestamp - animationStartTime;
        const animationDuration = 5000; // 5 seconds in milliseconds

        // Calculate the progress of the animation (0 to 1)
        const progress = Math.min(elapsedTime / animationDuration, 1);

        // Interpolate the latitude and longitude
        const newLat = currentLatLng.lat + (nextLatLng.lat - currentLatLng.lat) * progress;
        const newLng = currentLatLng.lng + (nextLatLng.lng - currentLatLng.lng) * progress;

        busMarker.setLatLng(new L.LatLng(newLat, newLng));

        // If animation is not complete, request the next frame
        if (progress < 1) {
            requestAnimationFrame(animateBus);
        }
    }

    // Check for new bus location every 5 seconds
    setInterval(getBusLocation, 5000);

    // Code for the "Find My Bus" button
    document.getElementById('find-bus-btn').addEventListener('click', function() {
        fetch('/get_locations')
            .then(response => response.json())
            .then(data => {
                if (data['bus-01']) {
                    var busLocation = [data['bus-01'].lat, data['bus-01'].lon];
                    mymap.setView(busLocation, 15);
                } else {
                    alert("Bus not found. Make sure the simulator is running!");
                }
            })
            .catch(error => console.error('Error finding bus:', error));
    });
</script>
